<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Emotion Detection & Conversation System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: auto 1fr auto;
            gap: 20px;
            min-height: 100vh;
        }

        .header {
            grid-column: 1 / -1;
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .header h1 {
            color: #4a5568;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 1.1em;
        }

        .video-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .video-container {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #video {
            width: 100%;
            height: 400px;
            object-fit: cover;
            border-radius: 10px;
        }

        .emotion-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            min-width: 200px;
        }

        .emotion-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .emotion-bar {
            width: 100px;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin-left: 10px;
        }

        .emotion-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4);
            transition: width 0.3s ease;
        }

        .chat-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            display: flex;
            flex-direction: column;
        }

        .landmarks-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            display: flex;
            flex-direction: column;
        }

        .landmarks-canvas-container {
            position: relative;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            margin-bottom: 15px;
            min-height: 400px;
            overflow: hidden;
        }

        #landmarksCanvas {
            width: 100%;
            height: 400px;
            border-radius: 8px;
        }

        .landmarks-info {
            background: #f8fafc;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }

        .landmarks-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .landmarks-stat {
            background: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .landmarks-stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #48bb78;
        }

        .landmarks-stat-label {
            font-size: 0.9em;
            color: #718096;
            margin-top: 5px;
        }

        .chat-container {
            flex: 1;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8fafc;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .user-message {
            background: #4299e1;
            color: white;
            margin-left: auto;
        }

        .ai-message {
            background: #48bb78;
            color: white;
        }

        .emotion-tag {
            font-size: 0.8em;
            opacity: 0.8;
            margin-top: 5px;
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        #messageInput {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        #messageInput:focus {
            border-color: #4299e1;
        }

        #sendBtn {
            padding: 12px 20px;
            background: #4299e1;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s ease;
        }

        #sendBtn:hover {
            background: #3182ce;
        }

        .stats-section {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .start-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.3s ease;
            margin: 10px;
        }

        .start-btn:hover {
            background: #38a169;
        }

        .stop-btn {
            background: #f56565;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.3s ease;
            margin: 10px;
        }

        .stop-btn:hover {
            background: #e53e3e;
        }

        .status {
            padding: 10px;
            text-align: center;
            font-weight: bold;
            border-radius: 10px;
            margin: 10px 0;
        }

        .status.connected {
            background: #c6f6d5;
            color: #22543d;
        }

        .status.disconnected {
            background: #fed7d7;
            color: #742a2a;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr 1fr;
                padding: 15px;
            }
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            #video {
                height: 300px;
            }

            .chat-container {
                max-height: 300px;
            }

            #landmarksCanvas {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ AI Emotion Detection & Conversation System</h1>
            <p>Real-time emotion detection with AI-powered conversations using Gemini</p>
        </div>

        <div class="video-section">
            <h2>üé• Live Video Feed</h2>
            <div class="video-container">
                <video id="video" autoplay muted></video>
                <div class="emotion-overlay" id="emotionOverlay">
                    <h3>üòä Current Emotions</h3>
                    <div id="emotionList"></div>
                </div>
            </div>
            <div>
                <button id="startBtn" class="start-btn">Start Camera</button>
                <button id="stopBtn" class="stop-btn" style="display: none;">Stop Camera</button>
                <div id="status" class="status disconnected">Camera: Disconnected</div>
            </div>
        </div>

        <div class="chat-section">
            <h2>üí¨ AI Conversation</h2>
            <div class="chat-container" id="chatContainer">
                <div class="message ai-message">
                    Hello! I can see your emotions and respond accordingly. How are you feeling today?
                </div>
            </div>
            <div class="input-container">
                <input type="text" id="messageInput" placeholder="Type your message here..." disabled>
                <button id="sendBtn" disabled>Send</button>
            </div>
        </div>

        <div class="landmarks-section">
            <h2>üéØ Face Landmarks & Emotion Mask</h2>
            <div class="landmarks-canvas-container">
                <canvas id="landmarksCanvas"></canvas>
            </div>
            <div class="landmarks-info">
                <h3>üìç Face Structure Detection</h3>
                <div id="landmarksStatus">No face detected</div>
                <p style="font-size: 0.9em; color: #718096; margin: 10px 0;">
                    Green connected lines show facial structure: jawline, eyebrows, eyes, nose, and mouth. 
                    Dots represent individual landmark points with emotion-based coloring.
                </p>
                <div class="landmarks-stats">
                    <div class="landmarks-stat">
                        <div class="landmarks-stat-value" id="landmarkCount">0</div>
                        <div class="landmarks-stat-label">Landmarks</div>
                    </div>
                    <div class="landmarks-stat">
                        <div class="landmarks-stat-value" id="faceCount">0</div>
                        <div class="landmarks-stat-label">Faces</div>
                    </div>
                    <div class="landmarks-stat">
                        <div class="landmarks-stat-value" id="dominantEmotion">-</div>
                        <div class="landmarks-stat-label">Emotion</div>
                    </div>
                    <div class="landmarks-stat">
                        <div class="landmarks-stat-value" id="confidenceLevel">0%</div>
                        <div class="landmarks-stat-label">Confidence</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-section">
            <h2>üìä Emotion Analytics</h2>
            <div class="stats-grid">
                <div class="chart-container">
                    <canvas id="emotionChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        
        let socket;
        let video;
        let stream;
        let isStreaming = false;
        let currentEmotion = 'neutral';
        let emotionIntensity = 0.5;
        let emotionChart, timelineChart;
        let emotionHistory = [];
        let landmarksCanvas, landmarksCtx;
        let currentLandmarks = null;

        // Initialize 
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            initializeVideo();
            initializeChat();
            initializeCharts();
            initializeLandmarksCanvas();
        });

        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to server');
                updateStatus('Connected to AI Server', 'connected');
            });

            socket.on('disconnect', function() {
                console.log('Disconnected from server');
                updateStatus('Disconnected from Server', 'disconnected');
            });

            socket.on('emotion_detected', function(data) {
                updateEmotionDisplay(data);
                updateCharts(data);
                updateLandmarksDisplay(data);
                currentEmotion = data.emotion;
                emotionIntensity = data.confidence;
            });

            socket.on('error', function(data) {
                console.error('Socket error:', data);
                addMessage('System', `Error: ${data.message}`, 'error');
            });
        }

        function initializeVideo() {
            video = document.getElementById('video');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');

            startBtn.addEventListener('click', startCamera);
            stopBtn.addEventListener('click', stopCamera);
        }

        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 } 
                });
                video.srcObject = stream;
                isStreaming = true;
                
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'inline-block';
                updateStatus('Camera: Active', 'connected');
                
                // Enable chat
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                
                // Start sending frames
                sendFrames();
                
            } catch (err) {
                console.error('Error accessing camera:', err);
                updateStatus('Camera: Access Denied', 'disconnected');
                alert('Could not access camera. Please check permissions.');
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            isStreaming = false;
            
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            updateStatus('Camera: Disconnected', 'disconnected');
            
            // Disable chat
            document.getElementById('messageInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
        }

        function sendFrames() {
            if (!isStreaming) return;

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            if (canvas.width > 0 && canvas.height > 0) {
                ctx.drawImage(video, 0, 0);
                const imageData = canvas.toDataURL('image/jpeg');
                socket.emit('video_frame', { image: imageData });
            }
            
            setTimeout(sendFrames, 200); // Send frame every 200ms
        }

        function updateEmotionDisplay(data) {
            const emotionList = document.getElementById('emotionList');
            emotionList.innerHTML = '';

            // Sort emotions by confidence
            const sortedEmotions = Object.entries(data.all_emotions)
                .sort(([,a], [,b]) => b - a);

            sortedEmotions.forEach(([emotion, confidence]) => {
                const emotionItem = document.createElement('div');
                emotionItem.className = 'emotion-item';
                
                const percentage = (confidence * 100).toFixed(1);
                
                emotionItem.innerHTML = `
                    <span>${emotion}</span>
                    <div class="emotion-bar">
                        <div class="emotion-fill" style="width: ${percentage}%"></div>
                    </div>
                    <span>${percentage}%</span>
                `;
                
                emotionList.appendChild(emotionItem);
            });
        }

        function initializeLandmarksCanvas() {
            landmarksCanvas = document.getElementById('landmarksCanvas');
            landmarksCtx = landmarksCanvas.getContext('2d');
            
            // Set canvas size
            landmarksCanvas.width = landmarksCanvas.offsetWidth;
            landmarksCanvas.height = landmarksCanvas.offsetHeight;
            
            // Initial draw
            drawLandmarksCanvas();
            
            // Redraw on resize
            window.addEventListener('resize', function() {
                landmarksCanvas.width = landmarksCanvas.offsetWidth;
                landmarksCanvas.height = landmarksCanvas.offsetHeight;
                drawLandmarksCanvas();
            });
        }

        function updateLandmarksDisplay(data) {
            currentLandmarks = data.face_landmarks;
            
            // Update stats
            const landmarkCount = currentLandmarks && currentLandmarks.length > 0 
                ? currentLandmarks[0].landmarks ? currentLandmarks[0].landmarks.length : 0 
                : 0;
            
            document.getElementById('landmarkCount').textContent = landmarkCount;
            document.getElementById('faceCount').textContent = currentLandmarks ? currentLandmarks.length : 0;
            document.getElementById('dominantEmotion').textContent = data.emotion || '-';
            document.getElementById('confidenceLevel').textContent = data.confidence 
                ? (data.confidence * 100).toFixed(1) + '%' 
                : '0%';
            
            // Update status
            const statusElement = document.getElementById('landmarksStatus');
            if (currentLandmarks && currentLandmarks.length > 0) {
                statusElement.textContent = `Face detected with ${landmarkCount} landmarks`;
                statusElement.style.color = '#22543d';
            } else {
                statusElement.textContent = 'No face detected';
                statusElement.style.color = '#742a2a';
            }
            
            // Redraw canvas
            drawLandmarksCanvas();
        }

        function drawLandmarksCanvas() {
            const ctx = landmarksCtx;
            const canvas = landmarksCanvas;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw background
            ctx.fillStyle = '#f8fafc';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            const gridSize = 20;
            
            for (let x = 0; x < canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            for (let y = 0; y < canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            if (!currentLandmarks || currentLandmarks.length === 0) {
                // Draw placeholder text
                ctx.fillStyle = '#718096';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Start camera to see face landmarks', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Draw landmarks for each detected face
            currentLandmarks.forEach((faceData, faceIndex) => {
                if (!faceData.landmarks) return;
                
                const landmarks = faceData.landmarks;
                const scaleX = canvas.width / 640;  // Assuming 640px camera width
                const scaleY = canvas.height / 480; // Assuming 480px camera height
                
                // Function to draw connected lines between landmark points
                function drawConnectedLines(indices, color, lineWidth = 2, closed = false) {
                    if (indices.length < 2) return;
                    
                    ctx.strokeStyle = color;
                    ctx.lineWidth = lineWidth;
                    ctx.beginPath();
                    
                    // Move to first point
                    if (indices[0] < landmarks.length) {
                        const firstPoint = landmarks[indices[0]];
                        ctx.moveTo(firstPoint.x * scaleX, firstPoint.y * scaleY);
                    }
                    
                    // Draw lines to subsequent points
                    for (let i = 1; i < indices.length; i++) {
                        if (indices[i] < landmarks.length) {
                            const point = landmarks[indices[i]];
                            ctx.lineTo(point.x * scaleX, point.y * scaleY);
                        }
                    }
                    
                    // Close the shape if specified
                    if (closed && indices[0] < landmarks.length) {
                        const firstPoint = landmarks[indices[0]];
                        ctx.lineTo(firstPoint.x * scaleX, firstPoint.y * scaleY);
                    }
                    
                    ctx.stroke();
                }
                
                // Define face structure connections based on common facial landmark patterns
                // Face outline (jawline)
                const faceOutline = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16];
                drawConnectedLines(faceOutline, '#48bb78', 3, false);
                
                // Left eyebrow
                const leftEyebrow = [17, 18, 19, 20, 21];
                drawConnectedLines(leftEyebrow, '#38a169', 2, false);
                
                // Right eyebrow
                const rightEyebrow = [22, 23, 24, 25, 26];
                drawConnectedLines(rightEyebrow, '#38a169', 2, false);
                
                // Left eye outline
                const leftEye = [33, 34, 35, 36, 37, 38];
                drawConnectedLines(leftEye, '#2d7e3e', 2, true);
                
                // Right eye outline
                const rightEye = [39, 40, 41, 42, 43, 44];
                drawConnectedLines(rightEye, '#2d7e3e', 2, true);
                
                // Nose bridge and outline
                const noseBridge = [27, 28, 29, 30];
                drawConnectedLines(noseBridge, '#48bb78', 2, false);
                
                // Nose base
                const noseBase = [31, 32, 33, 34, 35];
                drawConnectedLines(noseBase, '#48bb78', 2, false);
                
                // Mouth outline
                const mouthOuter = [45, 46, 47, 48, 49, 50, 51, 52];
                drawConnectedLines(mouthOuter, '#38a169', 2, true);
                
                // Inner mouth
                if (landmarks.length > 60) {
                    const mouthInner = [53, 54, 55, 56, 57, 58, 59, 60];
                    drawConnectedLines(mouthInner, '#2d7e3e', 1, true);
                }
                
                // Additional face contour lines for a more complete mask
                if (landmarks.length > 100) {
                    // Cheek contours
                    const leftCheek = [1, 31, 39, 17];
                    drawConnectedLines(leftCheek, '#48bb78', 1, false);
                    
                    const rightCheek = [15, 35, 42, 26];
                    drawConnectedLines(rightCheek, '#48bb78', 1, false);
                    
                    // Forehead lines
                    const forehead = [17, 18, 19, 20, 21, 22, 23, 24, 25, 26];
                    drawConnectedLines(forehead, '#48bb78', 1, false);
                }
                
                // Draw face rectangle if available
                if (faceData.face_rect) {
                    const [x, y, w, h] = faceData.face_rect;
                    ctx.strokeStyle = '#4299e1';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x * scaleX, y * scaleY, w * scaleX, h * scaleY);
                }
                
                // Draw landmarks as green dots on top of the lines
                landmarks.forEach((landmark, index) => {
                    const x = landmark.x * scaleX;
                    const y = landmark.y * scaleY;
                    
                    // Different sizes and colors for different landmark types
                    let radius = 2;
                    let color = '#48bb78'; // Green
                    
                    // Key facial features get special treatment
                    if (index >= 17 && index <= 26) { // Eyebrows
                        radius = 3;
                        color = '#38a169';
                    } else if ((index >= 33 && index <= 44)) { // Eyes
                        radius = 4;
                        color = '#2d7e3e';
                    } else if (index >= 27 && index <= 35) { // Nose
                        radius = 3;
                        color = '#48bb78';
                    } else if (index >= 45 && index <= 60) { // Mouth
                        radius = 3;
                        color = '#38a169';
                    } else if (index <= 16) { // Face outline
                        radius = 3;
                        color = '#48bb78';
                    }
                    
                    // Draw the main dot
                    ctx.fillStyle = color;
                    ctx.beginPath();
                    ctx.arc(x, y, radius, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Add glow effect
                    ctx.fillStyle = color + '60'; // Semi-transparent
                    ctx.beginPath();
                    ctx.arc(x, y, radius + 1, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Add white center for visibility
                    ctx.fillStyle = '#ffffff';
                    ctx.beginPath();
                    ctx.arc(x, y, 1, 0, 2 * Math.PI);
                    ctx.fill();
                });
                
                // Draw landmark index numbers for key points (for debugging)
                ctx.fillStyle = '#2d3748';
                ctx.font = '8px Arial';
                ctx.textAlign = 'center';
                landmarks.slice(0, 68).forEach((landmark, index) => {
                    const x = landmark.x * scaleX;
                    const y = landmark.y * scaleY;
                    
                    // Only show numbers for key landmarks to avoid clutter
                    if (index <= 16 || (index >= 17 && index <= 26) || 
                        (index >= 27 && index <= 35) || (index >= 33 && index <= 44) || 
                        (index >= 45 && index <= 60)) {
                        ctx.fillText(index.toString(), x, y - 8);
                    }
                });
                
                // Add face mask overlay with semi-transparent fill
                if (landmarks.length > 16) {
                    ctx.fillStyle = currentEmotion ? 
                        getEmotionColor(currentEmotion) + '20' : '#48bb7820';
                    ctx.beginPath();
                    
                    // Create a face outline path
                    if (landmarks[0]) {
                        ctx.moveTo(landmarks[0].x * scaleX, landmarks[0].y * scaleY);
                        for (let i = 1; i <= 16 && i < landmarks.length; i++) {
                            ctx.lineTo(landmarks[i].x * scaleX, landmarks[i].y * scaleY);
                        }
                        ctx.closePath();
                        ctx.fill();
                    }
                }
            });
            
            // Draw emotion intensity visualization
            if (currentEmotion && emotionIntensity) {
                const barWidth = 200;
                const barHeight = 20;
                const barX = canvas.width - barWidth - 20;
                const barY = 20;
                
                // Background bar
                ctx.fillStyle = '#e2e8f0';
                ctx.fillRect(barX, barY, barWidth, barHeight);
                
                // Emotion bar
                ctx.fillStyle = getEmotionColor(currentEmotion);
                ctx.fillRect(barX, barY, barWidth * emotionIntensity, barHeight);
                
                // Label
                ctx.fillStyle = '#2d3748';
                ctx.font = '12px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`${currentEmotion}: ${(emotionIntensity * 100).toFixed(1)}%`, barX, barY - 5);
            }
        }
        
        function getEmotionColor(emotion) {
            const emotionColors = {
                'happy': '#48bb78',
                'sad': '#4299e1',
                'angry': '#f56565',
                'surprise': '#ed8936',
                'fear': '#9f7aea',
                'disgust': '#38b2ac',
                'neutral': '#718096'
            };
            return emotionColors[emotion] || '#718096';
        }

        function initializeChat() {
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');

            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) return;

            // Add user message to chat
            addMessage('You', message, 'user', currentEmotion, emotionIntensity);
            messageInput.value = '';

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        emotion: currentEmotion,
                        intensity: emotionIntensity
                    })
                });

                const data = await response.json();
                
                if (data.response) {
                    addMessage('AI', data.response, 'ai', data.emotion, data.intensity);
                } else {
                    addMessage('System', 'Error: Could not get AI response', 'error');
                }
            } catch (error) {
                console.error('Chat error:', error);
                addMessage('System', 'Error: Failed to send message', 'error');
            }
        }

        function addMessage(sender, text, type, emotion = null, intensity = null) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            let emotionTag = '';
            if (emotion && intensity) {
                emotionTag = `<div class="emotion-tag">Emotion: ${emotion} (${(intensity * 100).toFixed(1)}%)</div>`;
            }
            
            messageDiv.innerHTML = `
                <strong>${sender}:</strong> ${text}
                ${emotionTag}
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function initializeCharts() {
            // Emotion distribution chart
            const emotionCtx = document.getElementById('emotionChart').getContext('2d');
            emotionChart = new Chart(emotionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Happy', 'Sad', 'Angry', 'Surprise', 'Fear', 'Disgust', 'Neutral'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0, 0, 100],
                        backgroundColor: [
                            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', 
                            '#FECA57', '#FF9FF3', '#F38BA8'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Current Emotion Distribution'
                        }
                    }
                }
            });

            // Timeline chart
            const timelineCtx = document.getElementById('timelineChart').getContext('2d');
            timelineChart = new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Emotion Intensity',
                        data: [],
                        borderColor: '#4ECDC4',
                        backgroundColor: 'rgba(78, 205, 196, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Emotion Timeline'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1
                        }
                    }
                }
            });
        }

        function updateCharts(data) {
            // Update emotion chart
            const emotions = data.all_emotions;
            const values = Object.values(emotions).map(v => (v * 100).toFixed(1));
            emotionChart.data.datasets[0].data = values;
            emotionChart.update();

            // Update timeline chart
            const now = new Date().toLocaleTimeString();
            emotionHistory.push({
                time: now,
                emotion: data.emotion,
                confidence: data.confidence
            });

            // Keep only last 20 points
            if (emotionHistory.length > 20) {
                emotionHistory.shift();
            }

            timelineChart.data.labels = emotionHistory.map(h => h.time);
            timelineChart.data.datasets[0].data = emotionHistory.map(h => h.confidence);
            timelineChart.update();
        }

        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
    </script>
</body>
</html>
